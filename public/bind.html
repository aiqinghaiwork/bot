<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>绑定页面</title>
		<script src="https://cdn.bootcss.com/jquery/3.3.0/jquery.min.js"></script>
	</head>
	<body>
		<button id="mybtn">我的</button><br />
		手机号：<input id="phone" type="text" placeholder="手机号"/><br />
		验证码：<input id="code" type="text" placeholder="验证码" /><input id="getcodebtn" type="button" value="获取验证码"/><br />
		imtoken: <input id="imtoken" type="text" placeholder="imtoken" /><br />
		<button id="submitbtn">提交</button>
		
		<script>
			$(function(){
				//  获取验证码
				$("#getcodebtn").click(function(){
					var phone = $("#phone").val();
					$.ajax({
						type:"get",
						url:"/code/smsapi",
						data: {
							telphone: phone
						},
						async:true,
						success: function(res){
							console.log(res);
							$("#code").val(res.smscode);
						}
					});
				});
				// 提交绑定数据
				$("#submitbtn").click(function(){
					var telphone = $("#phone").val();
					var code = $("#code").val();
					var imtoken = $("#imtoken").val();
					//1.先查找localstrage中是否有用户识别码，如果有，使用这个值

					// 2.从url中查找
					function getRequest() {
						var url = window.location.search; //获取url中"?"符后的字串   
						var theRequest = new Object();   
						if (url.indexOf("?") != -1) {   
							var str = url.substr(1);   
							strs = str.split("&");   
							for(var i = 0; i < strs.length; i ++) {   
								theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);   
							}
						}
						return theRequest;   
					}
					var identitycode = getRequest().identitycode;// 用户识别码
					
					$.ajax({
						type:"post",
						url:"/code/smsbind",
						async:true,
						data: {
							telphone: telphone,
							smscode: code,
							imtoken: imtoken,
							identitycode: identitycode
						},
						success: function(res){
							console.log(res);
							if(res.code === 200){
								console.log(res);
								window.location.href = 'share.html?identitycode='+res.identitycode;
							}
						}
					});
				})
				
			})
		</script>
	</body>
</html>
